<!doctype html>
<html>
    <head>
        <title>双拼布局设计工具</title>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
        <meta name="keywords" content="Dvorak,QWERTY,键盘,布局,打字,双拼" />
        <meta name="author" content="毛毛雨(shangxuejin@gmail.com)" />
        <link rel="stylesheet" href="designassist/designassist.css" />
        <script type="text/javascript" src="scripts/jquery.min.js"></script>
        <link rel="shortcut icon" href="favicon.ico" mce_href="favicon.ico" type="image/x-icon" />
    </head>
    <body>
        <div id="keyboard">
            <script type="text/javascript">
                var keyboard, charPosition = {}, keyPercent = {};
                (function(){
                    var keyString = '~$\t%&\t7[\t5{\t3}\t1(\t9=\t0*\t2)\t4+\t6]\t8!\t`#\tBackspace\n' +
                    'Tab\t:;\t<,\t>.\tP\tY\tF\tG\tC\tR\tL\t?/\t^@\t|\\\n' +
                    'Caps Lock\tA\tO\tE\tU\tI\tD\tH\tT\tN\tS\t_-\tEnter\n' +
                    'Shift L\t"\'\tQ\tJ\tK\tX\tB\tM\tW\tV\tZ\tShift R\n' +
                    'Ctrl L\tWin L\tAlt L\tBlank\tAlt R\tWin R\tMenu\tCtrl R'.split('\n');
                    
                    var ctrlkeys = 'Backspace|Tab|Caps Lock|Enter|Shift L|Shift R|Ctrl L|Win L|Alt L|Blank|Alt R|Win R|Menu|Ctrl R';
                    
                    keyboard = getKeyborad(keyString, ctrlkeys);
                    
                    var rowkeyspans = '';
                    $.each(keyboard, function(ri, row){
                        rowkeyspans += '<div id="row' + ri + '">';
                        $.each(row, function(ki, key){
                            if (key instanceof Array) {
                                var keyId = 'key' + (ri * 100 + ki);
                                var cls = '';
                                if (ri >= 1 && ri <= 3 && ki >= 1 && ki <= 10) {
                                    cls = 'class="keymain" ';
                                    charPosition[key[0].toLowerCase()] = keyId;
                                    keyPercent[keyId] = 0;
                                }
                                rowkeyspans += '<div id="' + keyId + '" ' +
                                cls +
                                '><span>' +
                                key[0] +
                                '</span><span></span><span></span><span></span>' +
                                '<span>' +
                                (key[1] || '') +
                                '</span><span></span></div>';
                            }
                            else {
                                rowkeyspans += '<div id="key' + key.replace(/ /g, '') + '">' + (key === 'Blank' ? '' : key) + '</div>';
                            }
                        });
                        rowkeyspans += "</div>";
                    });
                    document.write(rowkeyspans);
                })();
                function getKeyborad(keyString, ctrlKeys){
                    var keyboard = new Array();
                    $.each(keyString.split('\n'), function(ind, val){
                        var row = new Array();
                        $.each(val.split('\t'), function(ind, val){
                            if ($.inArray(val, ctrlKeys.split('|')) >= 0) {
                                row.push(val);
                                return;
                            }
                            var key = new Array();
                            $.each(val.split(''), function(ind, val){
                                key.push(val);
                            });
                            row[ind] = key;
                        });
                        keyboard.push(row);
                    });
                    return keyboard;
                }
            </script>
        </div>
        <div id="final_count">
            <table>
                <tbody>
                    <script type="text/javascript">
                        (function(){
                            var trthtds = '';
                            for (var i = 0; i < 6; i++) {
                                trthtds += '<tr>';
                                for (var j = 0; j < 7; j++) {
                                    trthtds += '<th></th><td></td>';
                                }
                                trthtds += '</tr>';
                            }
                            document.write(trthtds);
                        })()
                    </script>
                </tbody>
            </table>
        </div>
        <script type="text/javascript" src="designassist/initfinalcount.js"></script>
        <script type="text/javascript">
            var initFinalCnt = {}, finalInitCnt = {};
            $(function(){
                var sum = 0;
                for (var i in initfinalcount) {
                    var fields = initfinalcount[i];
                    var init = fields[0], final = fields[1], cnt = Number(fields[2]);
                    initFinalCnt[init] || (initFinalCnt[init] = {});
                    initFinalCnt[init][final] = cnt;
                    finalInitCnt[final] || (finalInitCnt[final] = {});
                    finalInitCnt[final][init] = cnt;
                    sum += cnt;
                }
                finalInitCnt['*'] = sum;
                initFinalCnt['*'] = sum;
                
                for (var final in finalInitCnt) {
                    var finalSum = 0;
                    for (var init in finalInitCnt[final]) {
                        finalSum += finalInitCnt[final][init];
                    }
                    finalInitCnt[final]['*'] = finalSum;
                    finalInitCnt[final]['@'] = charPosition[final];
                }
                for (var init in initFinalCnt) {
                    if (init == '-' || init == '@' || init == '*') {
                        continue;
                    }
                    var initSum = 0;
                    for (var final in initFinalCnt[init]) {
                        initSum += initFinalCnt[init][final];
                    }
                    initFinalCnt[init]['*'] = initSum;
                    initFinalCnt[init]['@'] = charPosition[init];
                    keyPercent[initFinalCnt[init]['@']] = initFinalCnt[init]['*'];
                    $('#' + initFinalCnt[init]['@'] + ' span:eq(3)').addClass('smaller')//
                    /*_*/
                    .text(percent(keyPercent[initFinalCnt[init]['@']], initFinalCnt['*']));
                }
                
                var sorted = new Array();
                for (var final in finalInitCnt) {
                    if (final === '*') continue;
                    sorted.push({
                        'final': final,
                        '*': finalInitCnt[final]['*']
                    });
                }
                sorted.sort(function(a, b){
                    return b['*'] - a['*'];
                });
                var ths = $('#final_count table th');
                var tds = $('#final_count table td');
                for (var i = 0; i < sorted.length; i++) {
                    $(ths[i]).text(sorted[i].final).attr('id', 'final' + sorted[i].final)//
                    /*_*/
                    .attr('draggable', true).addClass('draggable');
                    $(tds[i]).text(percent(sorted[i]['*'], finalInitCnt['*']))//
                    /*_*/
                    .attr('draggable', true).addClass('draggable');
                }
                $(ths[tds.length - 3]).text('zh').attr('id', 'initzh');
                $(tds[tds.length - 3]).text(percent(initFinalCnt['zh']['*'], finalInitCnt['*']));
                $(ths[tds.length - 2]).text('ch').attr('id', 'initch');
                $(tds[tds.length - 2]).text(percent(initFinalCnt['ch']['*'], finalInitCnt['*']));
                $(ths[tds.length - 1]).text('sh').attr('id', 'initsh');
                $(tds[tds.length - 1]).text(percent(initFinalCnt['sh']['*'], finalInitCnt['*']));
                
                (function(){
                    var had = [];
                    for (var final in finalInitCnt) {
                        had.push(final);
                        if ($.inArray(final, ['*', '@', '-', 'er']) >= 0) {
                            continue;
                        }
                        var is = new Array();
                        for (var init in finalInitCnt[final]) {
                            if ($.inArray(init, ['*', '@', '-']) >= 0) {
                                continue;
                            }
                            is.push(init);
                        }
                        var toge = []
                        label1: for (var f in finalInitCnt) {
                            if ($.inArray(f, had) >= 0) continue;
                            if ($.inArray(f, ['*', '@', '-', 'er']) >= 0) {
                                continue;
                            }
                            for (var i in finalInitCnt[f]) {
                                if ($.inArray(i, ['*', '@', '-']) >= 0) {
                                    continue;
                                }
                                if ($.inArray(i, is) >= 0) continue label1;
                            }
                            toge.push(f);
                        }
                        if (toge.length > 0) {
                            if ($('#together table tr:last th').length >= 5) {
                                $('#together table ').append('<tr />');
                            }
                            $('#together table tr:last').append('<th>' + final + '</th><td>' + (toge) + '</td>')
                        }
                    }
                })();
            });
            function percent(x, y){
                var x = Math.round(x * 10000 / y);
                if (String(x).length == 1) return '0.0' + x;
                else if (String(x).length == 2) return '0.' + x;
                return String(x).replace(/\d\d$/, function(m){
                    return '.' + m;
                });
            }
        </script>
        <div id="together">
            <table>
                <tr></tr>
            </table>
        </div>
        <div id="idea"></div>
        <script type="text/javascript" src="designassist/idea.js"></script>
        <script type="text/javascript">
            var effect = 'copy';
            $(function(){
                $('#keyboard .keymain').each(function(index, elment){
                    $(elment).find('span:lt(2)').bind({
                        'mouseenter': function(){
                            var init = this.innerHTML.toLowerCase();
                            if (!initFinalCnt[init]) { return; }
                            $(this).addClass('mouseenter');
                            for (var final in initFinalCnt[init]) {
                                if (final == '*' || final == '@' || final == '-') {
                                    continue;
                                }
                                $('#' + finalInitCnt[final]['@'] + ' span:eq(2)').addClass('smaller ass')//
                                /*_*/
                                .text(percent(finalInitCnt[final][init] * 10, finalInitCnt['*']));
                            }
                        },
                        'mouseleave': function(){
                            $(this).removeClass('mouseenter');
                            var init = this.innerHTML.toLowerCase();
                            if (!initFinalCnt[init]) return;
                            for (var final in initFinalCnt[init]) {
                                if (final == '*' || final == '@' || final == '-') {
                                    continue;
                                }
                                $('#' + finalInitCnt[final]['@'] + ' span:eq(2)').removeClass('smaller').text('');
                            }
                        }
                    });
                    $(elment).find('span:gt(1)').bind({
                        'mouseenter': function(){
                            var final = this.innerHTML.toLowerCase();
                            if (!finalInitCnt[final]) return;
                            var left = (Number(finalInitCnt[final]['@'].substring(3)) % 100 <= 5);
                            var exchange = {
                                'false': 0,
                                'true': 0
                            };
                            for (var init in finalInitCnt[final]) {
                                if (init == '*' || init == '@' || init == '-') {
                                    continue;
                                }
                                var perc = percent(initFinalCnt[init][final] * 10, initFinalCnt['*']);
                                var l = (Number(initFinalCnt[init]['@'].substring(3)) % 100 <= 5);
                                exchange[l] += Number(perc);
                                $('#' + initFinalCnt[init]['@'] + ' span:eq(2)').addClass('smaller ass').text(perc);
                            }
                            exchange['contrib'] = percent(exchange[!left] - exchange[left], 100);
                            exchange[left] = percent(exchange[left], 100);
                            exchange[!left] = percent(exchange[!left], 100);
                            var text = 'contrib:\t' + (exchange['contrib']) + '\nleft:\t\t' + exchange['true'] + '\nright:\t\t' + exchange['false']
                            $(this).addClass('mouseenter').attr('title', text);
                        },
                        'mouseleave': function(){
                            $(this).removeClass('mouseenter');
                            var final = this.innerHTML.toLowerCase();
                            if (!finalInitCnt[final]) return;
                            for (var init in finalInitCnt[final]) {
                                if (init == '*' || init == '@' || init == '-') {
                                    continue;
                                }
                                $('#' + initFinalCnt[init]['@'] + ' span:eq(2)').removeClass('smaller').text('');
                            }
                        }
                    })
                });
                $('#final_count table th, #keyboard .keymain span:gt(0)').bind({
                    'dragstart': function(ev){
                        ev.stopPropagation();
                        var dt = ev.originalEvent.dataTransfer;
                        dt.setData('text', $(this).text());
                        if (this.tagName === 'TH') {
                            dt.effectAllowed = 'copy';
                            effect = 'copy';
                            $(this).addClass('dragging').next('td').addClass('dragging');
                        }
                        else {
                            dt.effectAllowed = 'move';
                            effect = 'move';
                            $(this).addClass('dragging');
                        }
                        // dt.setData('text/uri-list', dt.effectAllowed);
                        return true;
                    },
                    'dragend': function(ev){
                        var dt = ev.originalEvent.dataTransfer;
                        if (dt.dropEffect != 'copy' && dt.dropEffect != 'move') {
                            $(this).removeClass('dragging').next('td').removeClass('dragging');
                            return false;
                        }
                        if (dt.dropEffect == 'copy') {
                            $(this).attr('draggable', false).removeClass('draggable') //
                            /*_*/
                            .addClass('dragged').next('td').addClass('dragged');
                        }
                        else if (dt.dropEffect == 'move') {
                            if ('zh,ch,sh'.indexOf($(this).text()) >= 0) {
                                calMoveWeightFrom($(this).text(), $(this).parent()[0].id);
                            }
                            else {
                                calMoveWeight1($(this).text(), $(this).parent()[0].id);
                            }
                            $(this).text('').removeClass('dragging');
                        }
                        return false;
                    }
                });
                $('#keyboard .keymain').bind({
                    'dragenter': function(ev){
                        ev.stopPropagation();
                        ev.preventDefault();
                        var dt = ev.originalEvent.dataTransfer;
                        dt.dropEffect = dt.effectAllowed;
                        $(this).addClass('dragover');
                        return false;
                    },
                    'dragover': function(ev){
                        ev.stopPropagation();
                        ev.preventDefault();
                        $(this).addClass('dragover');
                        return false;
                    },
                    'dragleave': function(ev){
                        ev.preventDefault();
                        $(this).removeClass('dragover');
                        return false;
                    },
                    'drop': function(ev){
                        ev.preventDefault();
                        $(this).removeClass('dragover');
                        var dt = ev.originalEvent.dataTransfer;
                        var final = dt.getData('text');
                        
                        if ('zh,ch,sh'.indexOf(final) >= 0) {
                            initFinalCnt[final]['@'] = this.id;
                            $(this).find('span:eq(1)').text(final)//
                            /*_*/
                            .attr('draggable', true).addClass('draggable');
                            calMoveWeightTo(final, this.id);
                        }
                        else {
                            if (conflict(final, this)) { return false; }
                            finalInitCnt[final]['@'] = this.id;
                            if (!$(this).find('span:eq(5)').text()) {
                                $(this).find('span:eq(5)').text(final)//
                                /*_*/
                                .attr('draggable', true).addClass('draggable');
                            }
                            else if (!$(this).find('span:eq(4)').text()) {
                                $(this).find('span:eq(4)').text(final)//
                                /*_*/
                                .attr('draggable', true).addClass('draggable');
                            }
                            else {
                                $(this).find('span:eq(2)').text(final)//
                                /*_*/
                                .attr('draggable', true).addClass('draggable');
                            }
                            calMoveWeight2(final, this.id);
                        }
                        return false;
                    }
                });
                
                initialize(idea);
                
                $('#keyCtrlL').bind('click', function(){
                    var idea = {
                        'zh': $('#' + initFinalCnt['zh']['@'] + ' span:eq(0)').text().toLowerCase(),
                        'ch': $('#' + initFinalCnt['ch']['@'] + ' span:eq(0)').text().toLowerCase(),
                        'sh': $('#' + initFinalCnt['sh']['@'] + ' span:eq(0)').text().toLowerCase()
                    };
                    for (var final in finalInitCnt) {
                        if (final == '*' || final == '@' || final == '-') {
                            continue;
                        }
                        if (finalInitCnt[final]['@']) {
                            idea[final] = $('#' + finalInitCnt[final]['@'] + ' span:eq(0)').text().toLowerCase();
                        }
                    }
                    $('#idea').html('var idea = ' +
                    JSON.stringify(idea).replace('{', '{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;').replace(/,/g, function(m){
                        return '<br>&nbsp;&nbsp;&nbsp;&nbsp;' + m;
                    }).replace('}', "<br>};<br>"));
                });
            })
            
            function calMoveWeightFrom(init, key){
                keyPercent[key] -= initFinalCnt[init]['*'];
                var perc = keyPercent[key] ? percent(keyPercent[key], initFinalCnt['*']) : '';
                $('#' + key + ' span:eq(3)').text(perc);
            }
            
            function calMoveWeightTo(init, key){
                keyPercent[key] += initFinalCnt[init]['*'];
                $('#' + key + ' span:eq(3)')//
                /*_*/
                .text(percent(keyPercent[key], initFinalCnt['*']));
            }
            
            function calMoveWeight1(final, key){
                keyPercent[key] -= finalInitCnt[final]['*'];
                var perc = keyPercent[key] ? percent(keyPercent[key], finalInitCnt['*']) : '';
                $('#' + key + ' span:eq(3)').text(perc);
            }
            
            function calMoveWeight2(final, key){
                keyPercent[key] += finalInitCnt[final]['*'];
                $('#' + key + ' span:eq(3)')//
                /*_*/
                .text(percent(keyPercent[key], finalInitCnt['*']));
            }
            
            function initialize(design){
                for (var final in design) {
                    if ('zh,ch,sh'.indexOf(final) >= 0) {
                        initFinalCnt[final]['@'] = finalInitCnt[design[final]]['@'];
                        $('#' + initFinalCnt[final]['@'] + ' span:eq(1)').text(final)//
                        /*_*/
                        .attr('draggable', true).addClass('draggable');
                        keyPercent[initFinalCnt[final]['@']] = initFinalCnt[final]['*'];
                        $('#' + initFinalCnt[final]['@'] + ' span:eq(3)').addClass('smaller')//
                        /*_*/
                        .text(percent(keyPercent[initFinalCnt[final]['@']], initFinalCnt['*']));
                        
                        $('#init' + final).addClass('dragged').next('td').addClass('dragged');
                        continue;
                    }
                    
                    finalInitCnt[final]['@'] = charPosition[design[final]];
                    calMoveWeight2(final, finalInitCnt[final]['@']);
                    
                    var $key = $('#' + finalInitCnt[final]['@']);
                    $key.find('span:eq(3)').addClass('smaller') //
                    if (!$key.find('span:eq(5)').text()) {
                        $key.find('span:eq(5)').text(final) //
                        /*_*/
                        .attr('draggable', true).addClass('draggable');
                    }
                    else if (!$key.find('span:eq(4)').text()) {
                        $key.find('span:eq(4)').text(final)//
                        /*_*/
                        .attr('draggable', true).addClass('draggable');
                    }
                    else {
                        $key.find('span:eq(2)').text(final) //
                        /*_*/
                        .attr('draggable', true).addClass('draggable');
                    }
                    $('#final' + final).addClass('dragged').next('td').addClass('dragged');
                    
                }
            }
            
            function conflict(final, key){
                var assInits = new Array();
                for (var init in finalInitCnt[final]) {
                    if (init == '-') {
                        continue;
                    }
                    assInits.push(init);
                }
                for (var p in [5, 4, 2]) {
                    var has = $(key).find('span:eq(' + [5, 4, 2][p] + ')').text();
                    if (has) {
                        for (var init in finalInitCnt[has]) {
                            if (init == '*' || init == '@' || init == '-') {
                                continue;
                            }
                            if ($.inArray(init, assInits) >= 0) {
                                alert('conflict : ' + init + final + ' <-> ' + init + has);
                                $('#final_count #final' + final).removeClass('dragging')//
                                /*_*/
                                .removeClass('dragged').addClass('draggable').next('td').removeClass('dragged')//
                                /*_*/
                                .removeClass('dragging').end().attr('draggable', true);
                                return true;
                            }
                        }
                    }
                }
                return false;
            }
        </script>
    </body>
</html>
