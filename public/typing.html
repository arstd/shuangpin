<!doctype html>
<html>
    <head>
        <title>Typing</title>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
        <meta name="keywords" content="Dvorak,QWERTY,键盘,布局,打字,双拼" />
        <meta name="author" content="毛毛雨(shangxuejin@gmail.com)" />
        <script type="text/javascript" src="scripts/jquery.min.js"></script>
        <link rel="shortcut icon" href="favicon.ico" mce_href="favicon.ico" type="image/x-icon" />
        <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css" />
        <link rel="stylesheet" href="bootstrap/css/bootstrap-responsive.min.css" />
        <link rel="stylesheet" href="typing/typing.css" />
    </head>
    <body>
	<input type="text" id="handler" />
        <div id="typing"></div>
        <textarea id="text">
Facing the Sea With Spring Blossoms - HaiZi
面朝大海，春暖花开—海子

From tomorrow on, I will be a happy man.
从明天起，做一个幸福的人

Grooming, chopping and traveling all over the world.
喂马，劈柴，周游世界

From tomorrow on, I will care foodstuff and vegetable.
从明天起，关心粮食和蔬菜

Living in a house towards the sea, with spring blossoms.
我有一所房子，面朝大海，春暖花开

From tomorrow on,write to each of my dear ones.
从明天起，和每一个人通信

Telling them of my happiness.
告诉他们我的幸福

What the lightening of happiness has told me.
那幸福的闪电告诉我的

I will spread it to each of them.
我将告诉每一个人

Give a warm name for every river and every mountain.
给每一条河每一座山取一个温暖的名字

Strangers, I will also wish you happy.
陌生人，我也为你祝福

May you have a brilliant future!
愿你有一个灿烂的前程

May you lovers eventually become spouses!
愿有情人终成眷属

May you enjoy happiness in this earthly world!
愿你们在尘世获得幸福

I only wish to face the sea, with spring blossoms.
我只愿面朝大海，春暖花开
	</textarea>
	<button type="text" id="commit" class="btn btn-primary">Commit</button>
	<div id="stat">
		CharCount:<span id="charCount">-</span>,
		Current:<span id="currentCount">-</span>,
		RightCount:<span id="rightCount">-</span>,
		ErrorCount:<span id="errorCount">-</span>,
		BackCount:<span id="backspaceCount">-</span>,
		UsedTime:<span id="usedTime">-</span>s,
		Speed:<span id="speed">-</span>kpm
	</div>
        <script type="text/javascript">
	
	var typ = {
		stat: {
			charCount: $('#charCount'),
			currentCount: $('#currentCount'),
			rightCount: $('#rightCount'),
			errorCount: $('#errorCount'),
			backspaceCount: $('#backspaceCount'),			
			usedTime: $('#usedTime'),
			speed: $('#speed')
		}	
	};

        $(function(){
            $('#commit').on({
		'click': function(){
		        $('#typing').html($('#text').val()
			.replace(/[^\x00-\xff]/g, '')
			.replace(/[^\n]/g, function(m){
		            return '<span>' + m + '</span>';
		        }).replace(/\n\n+/g, '<br><br>').replace(/\n/g, '<br>')
			.replace(/span/, 'span class="current"'));
			$('#handler')[0].focus();
			typ.charCount = $('#text').val().length;
			typ.current = null;
			clearInterval(typ.timing);
		}
            });
	    $('#typing').on({
		'click': function() {
			$('#handler')[0].focus();
		}
	    });

            $('#handler').on({
		'keypress': function(event) {
		        event.preventDefault();
			switch (event.keyCode) {
			case 16 : return;
			case 8: return;
			default: 
				this.value = '';
				typing(event.keyCode);  
				return;
			}
		},
		'keydown':  function(event) {
			this.value = '';
			switch (event.keyCode) {
				case 16 : event.preventDefault();return;
				case 8: event.preventDefault();backspace(); return;
				default:  return;
			}
		}
            });
        });
	
	function backspace() {
		if (typ.currentCount) {
			typ.current.removeClass('current right error');
			typ.current = typ.current.prev().addClass('current');

			typ.backspaceCount++;
			typ.currentCount--;
		}
	}

	function typing(keyCode){
		if (typ.current == null) {
			startTyping();
		}	
		typ.currentCount++;

		typ.current.removeClass('current right error');


		var char = String.fromCharCode(keyCode);
		if(!event.shiftKey) char = char.toLowerCase();
		var requreChar = (typ.current[0].tagName == 'BR' ? ' ' : typ.current.text());

		if (char == requreChar) {
			typ.current.addClass('right');
			typ.rightCount++;
		} else {
			typ.current.addClass('error');
			typ.errorCount++;
		}
		
		typ.current = typ.current.next().addClass('current');
		if (!typ.current.length) {
			finishTyping();
		}
	}
	
	function startTyping() {
		typ = {
			charCount: typ.charCount,
			stat: typ.stat,
			stime: new Date(),
			rightCount: 0,
			errorCount: 0,
			backspaceCount: 0,
			currentCount: 0,
			current: $('#typing .current')
		}
		typ.timing = setInterval(fillTime, 500);
	}
	function fillTime() {
		typ.stat.charCount.text(typ.charCount),
		typ.stat.usedTime.text((new Date() - typ.stime)/1000),
		typ.stat.rightCount.text(typ.rightCount),
		typ.stat.errorCount.text(typ.errorCount),
		typ.stat.backspaceCount.text(typ.backspaceCount),
		typ.stat.currentCount.text(typ.currentCount);
		typ.stat.speed.text(Math.round(typ.currentCount/(new Date() - typ.stime)*60000));
		if (typ.current.length && typ.current.offset().top - $(document).scrollTop() > $(window).height() * 0.8) {
			$(document).scrollTop(window.innerHeight * 0.7 + $(document).scrollTop());
		}
	}
	function finishTyping() {
		clearInterval(typ.timing);
		fillTime();
		$('#handler').blur();
		alert('Congratulations: ' + Math.round(typ.currentCount / (new Date() - typ.stime) * 60000)  + 'kms');
	}
        </script>
    </body>
</html>

